(function(a){function b(e){var c=a.data(e,"edatagrid").options;a(e).datagrid(a.extend({},c,{onDblClickCell:function(f,g){if(c.editing){a(this).edatagrid("editRow",f);d(g);}},onClickCell:function(f,g){},onAfterEdit:function(g,h){c.editIndex=undefined;var f=h.isNewRecord?c.saveUrl:c.updateUrl;if(f){a.post(f,h,function(l){l.isNewRecord=null;a(e).datagrid("updateRow",{index:g,row:l});if(c.tree){var i=a(c.tree);var j=i.tree("find",h.id);if(j){j.text=h[c.treeTextField];i.tree("update",j);}else{var k=i.tree("find",h[c.treeParentField]);i.tree("append",{parent:(k?k.target:null),data:[{id:h.id,text:h[c.treeTextField]}]});}}c.onSave.call(e,g,h);},"json");}if(c.onAfterEdit){c.onAfterEdit.call(e,g,h);}},onCancelEdit:function(f,g){c.editIndex=undefined;if(g.isNewRecord){a(this).datagrid("deleteRow",f);}if(c.onCancelEdit){c.onCancelEdit.call(e,f,g);}},onBeforeLoad:function(g){a(this).datagrid("rejectChanges");if(c.tree){var f=a(c.tree).tree("getSelected");g[c.treeParentField]=f?f.id:undefined;}if(c.onBeforeLoad){c.onBeforeLoad.call(e,g);}}}));function d(h){var f=a(e).datagrid("getEditor",{index:c.editIndex,field:h});if(f){f.target.focus();}else{var g=a(e).datagrid("getEditors",c.editIndex);if(g.length){g[0].target.focus();}}}if(c.tree){a(c.tree).tree({url:c.treeUrl,onClick:function(f){a(e).datagrid("load");},onDrop:function(h,i,f){var g=a(this).tree("getNode",h).id;a.ajax({url:c.treeDndUrl,type:"post",data:{id:i.id,targetId:g,point:f},dataType:"json",success:function(){a(e).datagrid("load");}});}});}}a.fn.edatagrid=function(c,d){if(typeof c=="string"){var e=a.fn.edatagrid.methods[c];if(e){return e(this,d);}else{return this.datagrid(c,d);}}c=c||{};return this.each(function(){var f=a.data(this,"edatagrid");if(f){a.extend(f.options,c);}else{a.data(this,"edatagrid",{options:a.extend({},a.fn.edatagrid.defaults,a.fn.edatagrid.parseOptions(this),c)});}b(this);});};a.fn.edatagrid.parseOptions=function(c){return a.extend({},a.fn.datagrid.parseOptions(c),{});};a.fn.edatagrid.methods={options:function(d){var c=a.data(d[0],"edatagrid").options;return c;},enableEditing:function(c){return c.each(function(){var d=a.data(this,"edatagrid").options;d.editing=true;});},disableEditing:function(c){return c.each(function(){var d=a.data(this,"edatagrid").options;d.editing=false;});},editRow:function(d,c){return d.each(function(){var f=a(this);var e=a.data(this,"edatagrid").options;var g=e.editIndex;if(g!=c){if(f.datagrid("validateRow",g)){if(g>=0){if(e.onBeforeSave.call(this,g)==false){setTimeout(function(){f.datagrid("selectRow",g);},0);return;}}f.datagrid("endEdit",g);f.datagrid("beginEdit",c);e.editIndex=c;}else{setTimeout(function(){f.datagrid("selectRow",g);},0);}}});},addRow:function(c){return c.each(function(){var g=a(this);var e=a.data(this,"edatagrid").options;if(e.editIndex>=0){if(!g.datagrid("validateRow",e.editIndex)){g.datagrid("selectRow",e.editIndex);return;}if(e.onBeforeSave.call(this,e.editIndex)==false){setTimeout(function(){g.datagrid("selectRow",e.editIndex);},0);return;}g.datagrid("endEdit",e.editIndex);}g.datagrid("appendRow",{isNewRecord:true});var f=g.datagrid("getRows");e.editIndex=f.length-1;g.datagrid("beginEdit",e.editIndex);g.datagrid("selectRow",e.editIndex);if(e.tree){var d=a(e.tree).tree("getSelected");f[e.editIndex][e.treeParentField]=(d?d.id:0);}e.onAdd.call(this,e.editIndex,f[e.editIndex]);});},saveRow:function(c){return c.each(function(){var e=a(this);var d=a.data(this,"edatagrid").options;if(d.onBeforeSave.call(this,d.editIndex)==false){setTimeout(function(){e.datagrid("selectRow",d.editIndex);},0);return;}a(this).datagrid("endEdit",d.editIndex);});},cancelRow:function(c){return c.each(function(){var e=a(this);e.datagrid("cancelEdit",e.edatagrid("options").editIndex);var d=e.datagrid("getRowIndex",e.datagrid("getSelected"));e.datagrid("unselectRow",d);});},destroyRow:function(c){return c.each(function(){var e=a(this);var d=a.data(this,"edatagrid").options;var f=e.datagrid("getSelected");if(!f){a.messager.alert(d.destroyMsg.norecord.title,d.destroyMsg.norecord.msg,"warning");return;}a.messager.confirm(d.destroyMsg.confirm.title,d.destroyMsg.confirm.msg,function(h){var g=e.datagrid("getRowIndex",f);if(h){if(f.isNewRecord){e.datagrid("cancelEdit",g);}else{if(d.destroyUrl){a.post(d.destroyUrl,{id:f[""+d.idField+""]},function(){if(d.tree){e.datagrid("reload");var i=a(d.tree);var j=i.tree("find",f.id);if(j){i.tree("remove",j.target);}}else{e.datagrid("cancelEdit",g);e.datagrid("deleteRow",g);}d.onDestroy.call(e[0],g,f);});}else{e.datagrid("cancelEdit",g);e.datagrid("deleteRow",g);}}}else{e.datagrid("unselectRow",g);}});});}};a.fn.edatagrid.defaults=a.extend({},a.fn.datagrid.defaults,{editing:true,editIndex:-1,destroyMsg:{norecord:{title:"Warning!",msg:"No record is selected!"},confirm:{title:"Confirm!",msg:"Are you sure you want to delete?"}},destroyConfirmTitle:"Confirm!",destroyConfirmMsg:"Are you sure you want to delete?",norecordMsg:"No record is view!",url:null,saveUrl:null,updateUrl:null,destroyUrl:null,tree:null,treeUrl:null,treeDndUrl:null,treeTextField:"name",treeParentField:"parentId",onAdd:function(c,d){},onBeforeSave:function(c){},onSave:function(c,d){},onDestroy:function(c,d){}});})(jQuery);