(function(a){function b(e){var c=a.data(e,"etreegrid").options;a(e).treegrid(a.extend({},c,{onDblClickRow:function(f){if(c.editing){a(this).etreegrid("editRow",f.id);d(f.field);}},onClickRow:function(f){},onAfterEdit:function(h,g){c.editIndex=undefined;var f=h.isNewRecord?c.saveUrl:c.updateUrl;if(f){a.post(f,h,function(l){l.isNewRecord=null;if(c.tree){var i=a(c.tree);var j=i.tree("find",h.id);if(j){j.text=h[c.treeTextField];i.tree("update",j);}else{var k=i.tree("find",h[c.treeParentField]);i.tree("append",{parent:(k?k.target:null),data:[{id:h.id,text:h[c.treeTextField]}]});}}c.onSave.call(e,h.id,h);setTimeout(function(){var m=a(e);var n=m.treegrid("getParent",h.id);if(n){m.treegrid("reload",n.id);}else{m.treegrid("reload");}},50);},"json");}if(c.onAfterEdit){c.onAfterEdit.call(e,h);}},onCancelEdit:function(f){c.editIndex=undefined;if(f.isNewRecord){a(this).treegrid("remove",f.id);}},onBeforeExpand:function(g){var f=c.url;if(f){if(f.indexOf("?")>0){f=f.substring(0,f.indexOf("?"));}}c.url=f+"?"+c.idField+"="+g.id;},onBeforeLoad:function(g,f){}}));function d(h){var f=a(e).treegrid("getEditor",{id:c.editIndex,field:h});if(f){f.target.focus();}else{var g=a(e).treegrid("getEditors",c.editIndex);if(g.length){g[0].target.focus();}}}if(c.tree){a(c.tree).tree({url:c.treeUrl,onClick:function(f){a(e).treegrid("load");},onDrop:function(h,i,f){var g=a(this).tree("getNode",h).id;a.ajax({url:c.treeDndUrl,type:"post",data:{id:i.id,targetId:g,point:f},dataType:"json",success:function(){a(e).treegrid("load");}});}});}}a.fn.etreegrid=function(c,d){if(typeof c=="string"){var e=a.fn.etreegrid.methods[c];if(e){return e(this,d);}else{return this.treegrid(c,d);}}c=c||{};return this.each(function(){var f=a.data(this,"etreegrid");if(f){a.extend(f.options,c);}else{a.data(this,"etreegrid",{options:a.extend({},a.fn.etreegrid.defaults,a.fn.etreegrid.parseOptions(this),c)});}b(this);});};a.fn.etreegrid.parseOptions=function(c){return a.extend({},a.fn.treegrid.parseOptions(c),{});};a.fn.etreegrid.methods={options:function(d){var c=a.data(d[0],"etreegrid").options;return c;},enableEditing:function(c){return c.each(function(){var d=a.data(this,"etreegrid").options;d.editing=true;});},disableEditing:function(c){return c.each(function(){var d=a.data(this,"etreegrid").options;d.editing=false;});},editRow:function(d,c){return d.each(function(){var f=a(this);var e=a.data(this,"etreegrid").options;var g=e.editIndex;if(g!=c){if(f.datagrid("validateRow",g)){if(g>=0){if(e.onBeforeSave.call(this,g)==false){setTimeout(function(){f.treegrid("select",g);},0);return;}}f.treegrid("endEdit",g);f.treegrid("beginEdit",c);e.editIndex=c;}else{setTimeout(function(){f.treegrid("select",g);},0);}}});},addRow:function(c){return c.each(function(){var g=a(this);var e=a.data(this,"etreegrid").options;if(e.editIndex>=0){if(!g.datagrid("validateRow",e.editIndex)){g.treegrid("select",e.editIndex);return;}if(e.onBeforeSave.call(this,e.editIndex)==false){setTimeout(function(){g.treegrid("select",e.editIndex);},0);return;}g.treegrid("endEdit",e.editIndex);}g.treegrid("append",{isNewRecord:true});var f=g.treegrid("getRows");e.editIndex=f.length-1;g.treegrid("beginEdit",e.editIndex);g.treegrid("select",e.editIndex);if(e.tree){var d=a(e.tree).tree("getSelected");f[e.editIndex][e.treeParentField]=(d?d.id:0);}e.onAdd.call(this,e.editIndex,f[e.editIndex]);});},saveRow:function(c){return c.each(function(){var e=a(this);var d=a.data(this,"etreegrid").options;if(d.onBeforeSave.call(this,d.editIndex)==false){setTimeout(function(){e.treegrid("select",d.editIndex);},0);return;}a(this).treegrid("endEdit",d.editIndex);});},cancelRow:function(c){return c.each(function(){var e=a(this);e.treegrid("cancelEdit",e.etreegrid("options").editIndex);var d=e.treegrid("getSelected");if(d){e.treegrid("unselect",d.id);}});},reloadRow:function(c){return c.each(function(){var d=a(this);d.treegrid("reload");});},expandRow:function(c){return c.each(function(){var f=a(this);var e=f.treegrid("getSelected");if(e){f.treegrid("expand",e.id);}else{var d=a.data(this,"etreegrid").options;if(d.isExpandAll){f.treegrid("expandAll");}else{a.messager.alert(d.destroyMsg.norecord.title,d.destroyMsg.norecord.msg,"warning");return;}}});},collapseRow:function(c){return c.each(function(){var e=a(this);var d=e.treegrid("getSelected");if(d){e.treegrid("collapse",d.id);}else{e.treegrid("collapseAll");}});},destroyRow:function(c){return c.each(function(){var e=a(this);var d=a.data(this,"etreegrid").options;var f=e.treegrid("getSelected");if(!f){a.messager.alert(d.destroyMsg.norecord.title,d.destroyMsg.norecord.msg,"warning");return;}a.messager.confirm(d.destroyMsg.confirm.title,d.destroyMsg.confirm.msg,function(h){var g=e.treegrid("getRowIndex",f);if(h){if(f.isNewRecord){e.treegrid("cancelEdit",g);}else{if(d.destroyUrl){a.post(d.destroyUrl,{id:f[""+d.idField+""]},function(){if(d.tree){e.treegrid("reload");var i=a(d.tree);var j=i.tree("find",f.id);if(j){i.tree("remove",j.target);}}else{e.treegrid("remove",f.id);var k=e.treegrid("getParent",f.id);if(!(k&&k.id>0)){e.treegrid("reload");}else{e.treegrid("reload",k.id);}}d.onDestroy.call(e[0],g,f);});}else{e.treegrid("cancelEdit",g);e.treegrid("remove",f.id);}}}else{e.treegrid("unselect",f.id);}});});}};a.fn.etreegrid.defaults=a.extend({},a.fn.treegrid.defaults,{editing:true,editIndex:-1,destroyMsg:{norecord:{title:"Warning!",msg:"No record is selected!"},confirm:{title:"Confirm!",msg:"Are you sure you want to delete?"}},destroyConfirmTitle:"Confirm!",destroyConfirmMsg:"Are you sure you want to delete?",isExpandAll:false,url:null,saveUrl:null,updateUrl:null,destroyUrl:null,tree:null,treeUrl:null,treeDndUrl:null,treeTextField:"name",treeParentField:"parentId",onAdd:function(c,d){},onBeforeSave:function(c){},onSave:function(c,d){},onDestroy:function(c,d){}});})(jQuery);